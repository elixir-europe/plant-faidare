<!DOCTYPE html>

<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout/main :: layout(title=~{::title}, content=~{::main}, script=~{::script})}"
>
  <head>
    <title>
      Trial <th:block th:text="${model.trial.trialType}" />: <th:block
      th:text="${model.trial.trialName}" />
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  </head>

  <body>
    <main>
      <h1>
        Trial <th:block th:text="${model.trial.trialType}" />:
        <th:block th:text="${model.trial.trialName}" />
      </h1>

      <div th:replace="fragments/map::map"></div>

      <div class="f-card mt-4">
        <h2>Identification</h2>
        <div class="f-card-body">
          <div
            th:replace="fragments/row::text-row(label='Name', text=${model.trial.trialName})"
          ></div>
          <div
            th:replace="fragments/row::text-row(label='Identifier', text=${model.trial.trialDbId})"
          ></div>

          <!-- FIXME we should pass the trial url here, but there is no such property -->
          <div
            th:replace="fragments/source::source(source=${model.source}, url=null, entityType='trial')"
          ></div>

          <div
            th:replace="fragments/row::text-row(label='Project name', text=${model.trial.programName})"
          ></div>

          <!-- FIXME we are supposed to display seasons, but there is no such thing in the trial VO -->

          <th:block
            th:if="${model.trial.startDate != null && model.trial.endDate != null}"
          >
            <!-- FIXME use temporals to format dates once they're actually dates and not strings -->
            <div
              th:replace="fragments/row::text-row(label='Date', text=${'From ' + model.trial.startDate + ' to ' + model.trial.endDate })"
            ></div>
          </th:block>
          <th:block
            th:if="${model.trial.startDate != null && model.trial.endDate == null}"
          >
            <!-- FIXME use temporals to format dates once they're actually dates and not strings -->
            <div
              th:replace="fragments/row::text-row(label='Date', text=${'Started on ' + model.trial.startDate})"
            ></div>
          </th:block>

          <!-- FIXME the spec mentions DatasetAuthorships.license and DataetAuthorships.datasetPUI without specifying what we should do about it -->

          <div th:if="${model.choosableExportCriteria.observationLevelCodes}" class="d-flex justify-content-end">
            <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Export observations
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li th:each="levelCode : ${model.choosableExportCriteria.observationLevelCodes}">
                  <button class="dropdown-item" th:text="${levelCode}" data-bs-toggle="modal" data-bs-target="#exportModal" th:attr="data-level-code=${levelCode}"></button>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="f-card" th:unless="${#lists.isEmpty(model.germplasms)}">
        <h2>Genotype</h2>
        <div class="f-card-body">
          <div class="scroll-table-container scroll-table-container-big">
            <table
              class="
                table table-sm table-striped table-sticky table-responsive-sm
              "
            >
              <thead>
                <tr>
                  <th scope="col">Accession number</th>
                  <th scope="col">Name</th>
                  <th scope="col">Taxon</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="row : ${model.germplasms}">
                  <td>
                    <a
                      th:href="@{/germplasms/{germplasmId}(germplasmId=${row.germplasmDbId})}"
                      th:text="${row.accessionNumber}"
                    ></a>
                  </td>
                  <td th:text="${row.germplasmName}"></td>
                  <td
                    th:text="${(row.genus == null ? '' : row.genus) + ' ' + (row.species == null ? '' : row.species)+ ' ' + (row.subtaxa == null ? '' : row.subtaxa) }"
                  ></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- FIXME there should be variables here, but there's no way to get them -->

      <div class="f-card" th:unless="${#lists.isEmpty(model.trial.studies)}">
        <h2>Studies</h2>
        <div class="f-card-body">
          <div class="scroll-table-container scroll-table-container-big">
            <table
              class="
                table table-sm table-striped table-sticky table-responsive-sm
              "
            >
              <thead>
                <tr>
                  <th scope="col">Name</th>
                  <th scope="col">Location</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="row : ${model.trial.studies}">
                  <td>
                    <a
                      th:href="@{/studies/{studyId}(studyId=${row.studyDbId})}"
                      th:text="${row.studyName}"
                    ></a>
                  </td>
                  <td>
                    <a
                      th:href="@{/sites/{siteId}(siteId=${row.locationDbId})}"
                      th:text="${row.locationName}"
                    ></a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="f-card" th:unless="${#lists.isEmpty(model.trial.contact)}">
        <h2>Contact</h2>
        <div class="f-card-body">
          <div class="scroll-table-container">
            <table
              class="
                table table-sm table-striped table-sticky table-responsive-sm
              "
            >
              <thead>
                <tr>
                  <th scope="col">Role</th>
                  <th scope="col">Name</th>
                  <th scope="col">Email</th>
                  <th scope="col">Institution</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="row : ${model.trial.contact}">
                  <td th:text="${row.type}"></td>
                  <td th:text="${row.name}"></td>
                  <td th:text="${row.email}"></td>
                  <td th:text="${row.instituteName}"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="export-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="export-modal-label">
                Export observations for trial <em th:text="${model.trial.trialName}"></em>
              </h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="export-form">
                <div class="d-flex flex-column gap-3">
              <div class="row g-2">
                <div class="col-md" id="season-names">
                  <h2 class="fs-6">Year</h2>
                  <div class="small">
                    <button type="button" class="btn btn-link btn-sm py-0 check-all">All</button>
                    |
                    <button type="button" class="btn btn-link btn-sm py-0 uncheck-all">None</button>
                  </div>
                  <div class="f-trial-checklist">
                    <div th:each="seasonName, iterStat: ${model.choosableExportCriteria.seasonNames}" class="form-check">
                      <input class="form-check-input" type="checkbox" th:value="${seasonName}" th:id="|season-name-${iterStat.index}|">
                      <label class="form-check-label" th:for="|season-name-${iterStat.index}|" th:text="${seasonName}"></label>
                    </div>
                  </div>
                </div>
                <div class="col-md" id="study-locations">
                  <h2 class="fs-6">Study Location</h2>
                  <div class="small">
                    <button type="button" class="btn btn-link btn-sm py-0 check-all">All</button>
                    |
                    <button type="button" class="btn btn-link btn-sm py-0 uncheck-all">None</button>
                  </div>
                  <div class="f-trial-checklist">
                    <div th:each="studyLocation, iterStat: ${model.choosableExportCriteria.studyLocations}" class="form-check">
                      <input class="form-check-input" type="checkbox" th:value="${studyLocation}" th:id="|study-location-${iterStat.index}|">
                      <label class="form-check-label" th:for="|study-location-${iterStat.index}|" th:text="${studyLocation}"></label>
                    </div>
                  </div>
                </div>
                <div class="col-md" id="observation-variable-names">
                  <h2 class="fs-6">Obs. variable</h2>
                  <div class="small">
                    <button type="button" class="btn btn-link btn-sm py-0 check-all">All</button>
                    |
                    <button type="button" class="btn btn-link btn-sm py-0 uncheck-all">None</button>
                  </div>
                  <div class="f-trial-checklist">
                    <div th:each="observationVariableName, iterStat: ${model.choosableExportCriteria.obervationVariableNames}" class="form-check">
                      <input class="form-check-input" type="checkbox" th:value="${observationVariableName}" th:id="|observation-variable-name-${iterStat.index}|">
                      <label class="form-check-label" th:for="|observation-variable-name-${iterStat.index}|" th:text="${observationVariableName}"></label>
                    </div>
                  </div>
                </div>
              </div>
                <div class="row align-items-baseline g-2">
                  <div class="col-md-auto">
                    <h2 class="fs-6">Export format</h2>
                  </div>
                  <div class="col-md">
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="exportFormat" id="export-format-excel" value="EXCEL" checked>
                      <label class="form-check-label" for="export-format-excel">Excel</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="exportFormat" id="export-format-csv" value="CSV">
                      <label class="form-check-label" for="export-format-csv">CSV</label>
                    </div>
                  </div>
                </div>
              </div>
              </form>
            </div>
            <div class="modal-footer">
              <div class="d-none text-secondary" id="export-in-progress">Export in progress. Please be patient.</div>
              <div class="d-none text-danger" role="alert" id="export-error">The export failed. Please contact support.</div>
              <button type="submit" class="btn btn-secondary" form="export-form" id="export-submit">
                <span class="spinner-border spinner-border-sm me-1 d-none" aria-hidden="true" id="export-spinner"></span>
                Export
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script th:inline="javascript">
      faidare.initializeMap({
        contextPath: [[${model.contextPath}]],
        locations: [[${model.mapLocations}]]
      });
      faidare.initializeTrialExport({
        contextPath: [[${model.contextPath}]],
        trialDbId: [[${model.trial.trialDbId}]]
      });
    </script>
  </body>
</html>
