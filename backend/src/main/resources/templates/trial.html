<!DOCTYPE html>

<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout/main :: layout(title=~{::title}, content=~{::main}, script=~{::script})}"
>
  <head>
    <title>
      Trial <th:block th:text="${model.trial.trialType}" />: <th:block
      th:text="${model.trial.trialName}" />
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  </head>

  <body>
    <main>
      <h1>
        Trial <th:block th:text="${model.trial.trialType}" />:
        <th:block th:text="${model.trial.trialName}" />
      </h1>

      <div th:replace="fragments/map::map"></div>

      <div class="f-card mt-4">
        <h2>Identification</h2>
        <div class="f-card-body">
          <div
            th:replace="fragments/row::text-row(label='Name', text=${model.trial.trialName})"
          ></div>
          <div
            th:replace="fragments/row::text-row(label='Identifier', text=${model.trial.trialDbId})"
          ></div>

          <!-- FIXME we should pass the trial url here, but there is no such property -->
          <div
            th:replace="fragments/source::source(source=${model.source}, url=null, entityType='trial')"
          ></div>

          <div
            th:replace="fragments/row::text-row(label='Project name', text=${model.trial.programName})"
          ></div>

          <!-- FIXME we are supposed to display seasons, but there is no such thing in the trial VO -->

          <th:block
            th:if="${model.trial.startDate != null && model.trial.endDate != null}"
          >
            <!-- FIXME use temporals to format dates once they're actually dates and not strings -->
            <div
              th:replace="fragments/row::text-row(label='Date', text=${'From ' + model.trial.startDate + ' to ' + model.trial.endDate })"
            ></div>
          </th:block>
          <th:block
            th:if="${model.trial.startDate != null && model.trial.endDate == null}"
          >
            <!-- FIXME use temporals to format dates once they're actually dates and not strings -->
            <div
              th:replace="fragments/row::text-row(label='Date', text=${'Started on ' + model.trial.startDate})"
            ></div>
          </th:block>

          <!-- FIXME the spec mentions DatasetAuthorships.license and DataetAuthorships.datasetPUI without specifying what we should do about it -->


        </div>
      </div>

      <div class="f-card" th:unles="${#lists.isEmpty(model.germplasms)}">
        <h2>Genotype</h2>
        <div class="f-card-body">
          <div class="scroll-table-container scroll-table-container-big">
            <table
              class="
                table table-sm table-striped table-sticky table-responsive-sm
              "
            >
              <thead>
                <tr>
                  <th scope="col">Accession number</th>
                  <th scope="col">Name</th>
                  <th scope="col">Taxon</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="row : ${model.germplasms}">
                  <td>
                    <a
                      th:href="@{/germplasms/{germplasmId}(germplasmId=${row.germplasmDbId})}"
                      th:text="${row.accessionNumber}"
                    ></a>
                  </td>
                  <td th:text="${row.germplasmName}"></td>
                  <td
                    th:text="${(row.genus == null ? '' : row.genus) + ' ' + (row.species == null ? '' : row.species)+ ' ' + (row.subtaxa == null ? '' : row.subtaxa) }"
                  ></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- FIXME there should be variables here, but there's no way to get them -->

      <div class="f-card" th:unles="${#lists.isEmpty(model.trial.studies)}">
        <h2>Studies</h2>
        <div class="f-card-body">
          <div class="scroll-table-container scroll-table-container-big">
            <table
              class="
                table table-sm table-striped table-sticky table-responsive-sm
              "
            >
              <thead>
                <tr>
                  <th scope="col">Name</th>
                  <th scope="col">Location</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="row : ${model.trial.studies}">
                  <td>
                    <a
                      th:href="@{/studies/{studyId}(studyId=${row.studyDbId})}"
                      th:text="${row.studyName}"
                    ></a>
                  </td>
                  <td>
                    <a
                      th:href="@{/sites/{siteId}(siteId=${row.locationDbId})}"
                      th:text="${row.locationName}"
                    ></a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="f-card" th:unless="${#lists.isEmpty(model.trial.contact)}">
        <h2>Contact</h2>
        <div class="f-card-body">
          <div class="scroll-table-container">
            <table
              class="
                table table-sm table-striped table-sticky table-responsive-sm
              "
            >
              <thead>
                <tr>
                  <th scope="col">Role</th>
                  <th scope="col">Name</th>
                  <th scope="col">Email</th>
                  <th scope="col">Institution</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="row : ${model.trial.contact}">
                  <td th:text="${row.type}"></td>
                  <td th:text="${row.name}"></td>
                  <td th:text="${row.email}"></td>
                  <td th:text="${row.instituteName}"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </main>

    <script th:inline="javascript">
      faidare.initializeMap({
        contextPath: [[${model.contextPath}]],
        locations: [[${model.mapLocations}]]
      });
    </script>
  </body>
</html>
